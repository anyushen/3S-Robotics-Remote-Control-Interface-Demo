<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modbus控制界面</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>Modbus测试控制界面</h1>
    <div class="button-container">
        <button onclick="sendCommand('启动')">启动</button>
        <button onclick="sendCommand('暂停')">暂停</button>
        <button onclick="sendCommand('再启动')">再启动</button>
        <button onclick="sendCommand('一键回安全点')">一键回安全点</button>
        <button onclick="sendCommand('控制功能')">控制功能</button>
        <button onclick="sendCommand('从精拍启动')">从精拍启动</button>
    </div>
    <!-- 新增模式选择三位旋钮 -->
    <div class="mode-selector">
        <label for="mode-select">模式选择：</label>
        <select id="mode-select" onchange="sendModeCommand(this.value)">
            <option value="null">未选择</option>
            <option value="remote">远程</option>
            <option value="auto">自动</option>
            <option value="manual">手动</option>
        </select>
    </div>
    <div id="message"></div>

    <!-- 新增机器人控制界面 -->
    <div id="robot-control" style="display:none;">
        <h2>机器人控制界面</h2>
        <label for="speed-input">速度控制 (0 - 255):</label>
        <input type="number" id="speed-input" min="0" max="255" value="0">
        <button onclick="sendSpeedCommand()">设置速度</button>
        <button id="btn-plus-x" onmousedown="sendControlSignal('+X', true)" onmouseup="sendControlSignal('+X', false)">+X</button>
        <button id="btn-minus-x" onmousedown="sendControlSignal('-X', true)" onmouseup="sendControlSignal('-X', false)">-X</button>
        <button id="btn-plus-y" onmousedown="sendControlSignal('+Y', true)" onmouseup="sendControlSignal('+Y', false)">+Y</button>
        <button id="btn-minus-y" onmousedown="sendControlSignal('-Y', true)" onmouseup="sendControlSignal('-Y', false)">-Y</button>
        <button id="btn-plus-z" onmousedown="sendControlSignal('+Z', true)" onmouseup="sendControlSignal('+Z', false)">+Z</button>
        <button id="btn-minus-z" onmousedown="sendControlSignal('-Z', true)" onmouseup="sendControlSignal('-Z', false)">-Z</button>
        <button id="btn-plus-t" onmousedown="sendControlSignal('+T', true)" onmouseup="sendControlSignal('+T', false)">+T</button>
        <button id="btn-minus-t" onmousedown="sendControlSignal('-T', true)" onmouseup="sendControlSignal('-T', false)">-T</button>
        <!-- 新增退出控制按钮 -->
        <button id="btn-exit-control" onclick="exitControl()">退出控制</button>
    </div>

    <script>
        function sendCommand(command) {
            fetch('/execute_command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `command=${command}`
            })
            .then(response => response.json())
            .then(data => {
                const messageDiv = document.getElementById('message');
                messageDiv.innerHTML = data.message;
                if (command === '控制功能') {
                    document.getElementById('robot-control').style.display = 'block';
                }
            });
        }

        function sendModeCommand(mode) {
            fetch('/set_mode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `mode=${mode}`
            })
            .then(response => response.json())
            .then(data => {
                const messageDiv = document.getElementById('message');
                messageDiv.innerHTML = data.message;
            });
        }

        function sendControlSignal(signal, value) {
            const encodedSignal = encodeURIComponent(signal);
            fetch('/send_control_signal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `signal=${encodedSignal}&value=${value}`
            })
            .then(response => response.json())
            .then(data => {
                const messageDiv = document.getElementById('message'); // 获取显示消息的元素
                messageDiv.innerHTML = data.message; // 将消息显示在页面上
            })
            .catch(error => {
                console.error('发送控制信号时出错:', error);
            });
        }

        // 新增退出控制函数
        function exitControl() {
            document.getElementById('robot-control').style.display = 'none';
        }

        function sendSpeedCommand() {
            const speedInput = document.getElementById('speed-input');
            const speed = parseInt(speedInput.value);
            if (isNaN(speed) || speed < 0 || speed > 255) {
                alert('请输入 0 - 255 之间的数字');
                return;
            }
            fetch('/set_speed', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `speed=${speed}`
            })
            .then(response => response.json())
            .then(data => {
                const messageDiv = document.getElementById('message');
                messageDiv.innerHTML = data.message;
            })
            .catch(error => {
                console.error('发送速度信号时出错:', error);
            });
        }

    </script>
</body>
</html>